<!-- Modal Overlay -->
@if (isOpen()) {
  <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" (click)="closeModal()">
    <!-- Modal Content -->
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" (click)="$event.stopPropagation()">
      <!-- Header -->
      <div class="sticky top-0 bg-white border-b border-neutral-200 px-6 py-4 flex items-center justify-between">
        <h2 class="text-2xl font-bold text-black">
          {{ isEditMode() ? 'Editar Producto' : 'Crear Nuevo Producto' }}
        </h2>
        <button
          (click)="closeModal()"
          class="p-2 hover:bg-neutral-100 rounded-lg transition-colors">
          <svg class="w-6 h-6 text-neutral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Form -->
      <form (ngSubmit)="onSubmit()" class="p-6 space-y-6">
        <!-- Nombre -->
        <div>
          <label class="block text-sm font-medium text-neutral-700 mb-2">
            Nombre del Producto *
          </label>
          <input
            type="text"
            [value]="formData().nombre"
            (input)="updateField('nombre', $event)"
            class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none"
            placeholder="Ej: Camiseta Rock Band"
            required>
          @if (errors().nombre) {
            <p class="mt-1 text-sm text-red-600">{{ errors().nombre }}</p>
          }
        </div>

        <!-- Descripción -->
        <div>
          <label class="block text-sm font-medium text-neutral-700 mb-2">
            Descripción *
          </label>
          <textarea
            [value]="formData().descripcion"
            (input)="updateField('descripcion', $event)"
            rows="4"
            class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none resize-none"
            placeholder="Describe el producto..."
            required></textarea>
          @if (errors().descripcion) {
            <p class="mt-1 text-sm text-red-600">{{ errors().descripcion }}</p>
          }
        </div>

        <!-- Precio -->
        <div>
          <label class="block text-sm font-medium text-neutral-700 mb-2">
            Precio (COP) *
          </label>
          <input
            type="number"
            [value]="formData().precio"
            (input)="updateField('precio', $event)"
            min="0"
            step="1000"
            class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none"
            placeholder="50000"
            required>
          @if (errors().precio) {
            <p class="mt-1 text-sm text-red-600">{{ errors().precio }}</p>
          }
        </div>

        <!-- Género -->
        <div>
          <label class="block text-sm font-medium text-neutral-700 mb-2">
            Género *
          </label>
          <select
            [value]="formData().genero"
            (change)="updateField('genero', $event)"
            class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none"
            required>
            <option value="">Selecciona un género</option>
            <option value="Hombre">Hombre</option>
            <option value="Mujer">Mujer</option>
            <option value="Unisex">Unisex</option>
          </select>
          @if (errors().genero) {
            <p class="mt-1 text-sm text-red-600">{{ errors().genero }}</p>
          }
        </div>

        <!-- Categorías -->
        <div>
          <label class="block text-sm font-medium text-neutral-700 mb-2">
            Categorías *
          </label>
          <div class="space-y-2">
            <!-- Input para nueva categoría -->
            <div class="flex gap-2">
              <input
                type="text"
                [value]="newCategory()"
                (input)="updateNewCategory($event)"
                (keydown.enter)="addCategory($event)"
                class="flex-1 px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none"
                placeholder="Escribe una categoría y presiona Enter">
              <button
                type="button"
                (click)="addCategory()"
                class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                Agregar
              </button>
            </div>

            <!-- Lista de categorías -->
            @if (formData().categorias.length > 0) {
              <div class="flex flex-wrap gap-2 p-3 bg-neutral-50 rounded-lg">
                @for (category of formData().categorias; track $index) {
                  <span class="inline-flex items-center gap-2 px-3 py-1 bg-blue-500 text-white rounded-full text-sm">
                    {{ category }}
                    <button
                      type="button"
                      (click)="removeCategory($index)"
                      class="hover:bg-blue-600 rounded-full p-0.5 transition-colors">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </span>
                }
              </div>
            }
          </div>
          @if (errors().categorias) {
            <p class="mt-1 text-sm text-red-600">{{ errors().categorias }}</p>
          }
        </div>

        <!-- URLs de Imágenes -->
        <div>
          <label class="block text-sm font-medium text-neutral-700 mb-2">
            Imágenes (URLs) *
          </label>
          <div class="space-y-2">
            <!-- Input para nueva imagen -->
            <div class="flex gap-2">
              <input
                type="url"
                [value]="newImage()"
                (input)="updateNewImage($event)"
                (keydown.enter)="addImage($event)"
                class="flex-1 px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none"
                placeholder="https://ejemplo.com/imagen.jpg">
              <button
                type="button"
                (click)="addImage()"
                class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                Agregar
              </button>
            </div>

            <!-- Lista de imágenes con preview -->
            @if (formData().imagenes.length > 0) {
              <div class="grid grid-cols-2 gap-3">
                @for (image of formData().imagenes; track $index) {
                  <div class="relative group">
                    <img
                      [src]="image"
                      [alt]="'Imagen ' + ($index + 1)"
                      class="w-full h-32 object-cover rounded-lg border border-neutral-300"
                      (error)="onImageError($event)">
                    <button
                      type="button"
                      (click)="removeImage($index)"
                      class="absolute top-2 right-2 p-1.5 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                }
              </div>
            }
          </div>
          @if (errors().imagenes) {
            <p class="mt-1 text-sm text-red-600">{{ errors().imagenes }}</p>
          }
        </div>

        <!-- Error general -->
        @if (submitError()) {
          <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg">
            {{ submitError() }}
          </div>
        }

        <!-- Botones de acción -->
        <div class="flex items-center justify-end gap-3 pt-4 border-t border-neutral-200">
          <button
            type="button"
            (click)="closeModal()"
            [disabled]="saving()"
            class="px-6 py-2 border border-neutral-300 text-neutral-700 rounded-lg hover:bg-neutral-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
            Cancelar
          </button>
          <button
            type="submit"
            [disabled]="saving() || !isFormValid()"
            class="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
            @if (saving()) {
              <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            }
            <span>{{ isEditMode() ? 'Actualizar' : 'Crear' }} Producto</span>
          </button>
        </div>
      </form>
    </div>
  </div>
}
